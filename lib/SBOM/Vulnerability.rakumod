use SBOM::enums:ver<0.0.11>:auth<zef:lizmat> <
  Justification Response RiskMethodology Severity VersionAffection
  VulnerabilityState
>;

use SBOM::subsets:ver<0.0.11>:auth<zef:lizmat> <
  bom-ref bom-refOrLink number PositiveInt URL versionRange versionString
>;

use SBOM:ver<0.0.11>:auth<zef:lizmat>;
use SBOM::Attachment:ver<0.0.11>:auth<zef:lizmat>;
use SBOM::Organization:ver<0.0.11>:auth<zef:lizmat>;
use SBOM::Property:ver<0.0.11>:auth<zef:lizmat>;
use SBOM::Source:ver<0.0.11>:auth<zef:lizmat>;
use SBOM::Tool:ver<0.0.11>:auth<zef:lizmat>;

#- Advisory --------------------------------------------------------------------
#| An advisory of a vulnerability.
class SBOM::Advisory:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| An optional name of the advisory.
    has Str $.title;

#| Location where the advisory can be obtained.
    has URL $.url is required;
}

#- AffectedVersion -------------------------------------------------------------
#| A version or range of versions and their status.
class SBOM::AffectedVersion:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| A single version of a component or service.
    has versionString $.version;

#| A version range specified in Package URL Version Range syntax
    has versionRange $.range;

#| The vulnerability status for the version or range of versions.
    has VersionAffection $.status;

    submethod TWEAK() {
        die "Must have 'version' or 'range' specified"
          unless $!version || $!range;
    }
}

#- Affects  --------------------------------------------------------------------
#| The components or services that are affected by the vulnerability.
class SBOM::Affects:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| References a component or service by the objects bom-ref.
    has bom-refOrLink $.ref is required;

#| Zero or more individual versions or range of versions.
    has SBOM::AffectedVersion @.versions;

    # These should probably be auto-generated in RakUAST at some point
    method versions(SBOM::Affects:D:) { @!versions.List }
}

#- Analysis --------------------------------------------------------------------
#| An assessment of the impact and exploitability of a vulnerability.
class SBOM::Analysis:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| Declares the current state of an occurrence of a vulnerability, after
#| automated or manual analysis.
    has VulnerabilityState $.state;

#| The rationale of why the impact analysis state was asserted.
    has Justification $.justification;

#| A response to the vulnerability by the manufacturer, supplier, or
#| project responsible for the affected component or service. More than
#| one response is allowed. Responses are strongly encouraged for
#| vulnerabilities where the analysis state is exploitable.
    has Response @.response;

#| Detailed description of the impact including methods used during
#| assessment. If a vulnerability is not exploitable, this field should
#| include specific details on why the component or service is not
#| impacted by this vulnerability.
    has Str $.detail;

#| The date and time (timestamp) when the analysis was first issued.
    has DateTime $.firstIssued;

#| The date and time (timestamp) when the analysis was last updated.
    has DateTime $.lastUpdated;

    # These should probably be auto-generated in RakUAST at some point
    method response(SBOM::Analysis:D:) { @!response.List }
}

#- Credits ---------------------------------------------------------------------
#| Individuals or organizations credited with the discovery of a
#| vulnerability.
class SBOM::Credits:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| The organizations credited with vulnerability discovery.
    has SBOM::Organization @.organizations;

#| The individuals, not associated with organizations, that are
#| credited with vulnerability discovery.
    has SBOM::Contact @.individuals;

    # These should probably be auto-generated in RakUAST at some point
    method organizations(SBOM::Credits:D:) { @!organizations.List }
    method individuals(  SBOM::Credits:D:) { @!individuals.List   }
}

#- ProofOfConcept --------------------------------------------------------------
#| Evidence used to reproduce a vulnerability.
class SBOM::ProofOfConcept:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| Precise steps to reproduce the vulnerability.
    has Str $.reproductionSteps;

#| A description of the environment in which reproduction was possible.
    has Str $.environment;

#| Supporting material that helps in reproducing or understanding how
#| reproduction is possible. This may include screenshots, payloads,
#| and PoC exploit code.
    has SBOM::Attachment @.supportingMaterial;

    # These should probably be auto-generated in RakUAST at some point
    method supportingMaterial(SBOM::ProofOfConcept:D:) {
        @!supportingMaterial.List
    }
}

#- Rating ----------------------------------------------------------------------
#| Defines the severity or risk ratings of a vulnerability.
class SBOM::Rating:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| The source that calculated the severity or risk rating of the
#| vulnerability.
    has SBOM::Source $.source;

#| The numerical score of the rating.
    has number $.score;

#| Textual representation of the severity that corresponds to the
#| numerical score of the rating.
    has Severity $.severity;

#| Specifies the severity or risk scoring methodology or standard used.
    has RiskMethodology $.method;

#| Textual representation of the metric values used to score the
#| vulnerability.
    has Str $.vector;

#| An optional reason for rating the vulnerability as it was.
    has Str $.justification;
}

#- SourceReference -------------------------------------------------------------
#| A reference to a source that published a vulnerability.
class SBOM::SourceReference:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| An identifier that uniquely identifies the vulnerability.
    has Str $.id;

#| The source that published the vulnerability.
    has SBOM::Source $.source;
}

#- Vulnerability ---------------------------------------------------------------
#| A Vulnerability identified in components or services
class SBOM::Vulnerability:ver<0.0.11>:auth<zef:lizmat> does SBOM {

#| An optional identifier which can be used to reference the
#| vulnerability elsewhere in the BOM.
    has bom-ref $.bom-ref;

#| The identifier that uniquely identifies the vulnerability.
    has Str $.id;

#| The source that published the vulnerability.
    has SBOM::Source $.source;

#| Zero or more pointers to vulnerabilities that are the equivalent of
#| the vulnerability specified. Often times, the same vulnerability may
#| exist in multiple sources of vulnerability intelligence, but have
#| different identifiers. References provide a way to correlate
#| vulnerabilities across multiple sources of vulnerability intelligence.
    has SBOM::SourceReference @.references;

#| List of vulnerability ratings.
    has SBOM::Rating @.ratings;

#| List of Common Weaknesses Enumerations (CWEs) codes that describes
#| this vulnerability.  For example 399 (of
#| https://cwe.mitre.org/data/definitions/399.html).
    has PositiveInt @.cwes;

#| A description of the vulnerability as provided by the source.
    has Str $.description;

#| If available, an in-depth description of the vulnerability as
#| provided by the source organization. Details often include
#| information useful in understanding root cause.
    has Str $.detail;

#| Recommendations of how the vulnerability can be remediated or
#| mitigated.
    has Str $.recommendation;

#| A bypass, usually temporary, of the vulnerability that reduces its
#| likelihood and/or impact. Workarounds often involve changes to
#| configuration or deployments.
    has Str $.workaround;

#| Evidence used to reproduce the vulnerability.
    has SBOM::ProofOfConcept $.proofOfConcept;

#| Published advisories of the vulnerability if provided.
    has SBOM::Advisory @.advisories;

#| The date and time (timestamp) when the vulnerability record was
#| created in the vulnerability database.
    has DateTime $.created;

#| The date and time (timestamp) when the vulnerability record was
#| first published.
    has DateTime $.published;

#| The date and time (timestamp) when the vulnerability record was
#| last updated.
    has DateTime $.updated;

#| The date and time (timestamp) when the vulnerability record was
#| rejected (if applicable).
    has DateTime $.rejected;

#| Individuals or organizations credited with the discovery of the
#| vulnerability.
    has SBOM::Credits $.credits;

#| An assessment of the impact and exploitability of the vulnerability.
    has SBOM::Analysis $.analysis;

#| The components or services that are affected by the vulnerability.
    has SBOM::Affects  @.affects;

#| Any additional properties as name-value pairs.
    has SBOM::Property @.properties;

#| The legacy tools used to identify, confirm, or score the
#| vulnerability.
    has SBOM::LegacyTool @!tools;

#| The tool used to identify, confirm, or score the vulnerability.
    has SBOM::Tool $!tools;

    method TWEAK-nameds(SBOM::Vulnerability:) { ("tools",) }

    submethod TWEAK(:$tools) {
        if $tools ~~ Positional {
            @!tools := $tools<>.map({
                SBOM::LegacyTool.new(|$_)
            }).List;
        }
        elsif $tools.defined {
            $!tools := SBOM::Tool.new(|$tools)
        }
    }

    method tools(SBOM::Vulnerability:D:) { $!tools // @!tools.List }

    # These should probably be auto-generated in RakUAST at some point
    method references(SBOM::Vulnerability:D:) { @!references.List }
    method ratings(   SBOM::Vulnerability:D:) { @!ratings.List    }
    method cwes(      SBOM::Vulnerability:D:) { @!cwes.List       }
    method advisories(SBOM::Vulnerability:D:) { @!advisories.List }
    method affects(   SBOM::Vulnerability:D:) { @!affects.List    }
    method properties(SBOM::Vulnerability:D:) { @!properties.List }
}

# vim: expandtab shiftwidth=4
